let wss,wsStatus,lastKeepAlive,url=`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/api/ws`,reconnectAttempts=0,maxReconnectAttempts=5,reconnectTimeout=null,currentPath=window.location.pathname,currentProps={},cachedRoutes={},renderNow=!1;function setupClientRouting(){document.addEventListener("click",(e=>{const t=e.target.closest("a");if(t){e.preventDefault();const n=t.getAttribute("href");n&&(n.startsWith("http")?window.open(n,"_blank"):render(n))}})),document.addEventListener("mouseover",(e=>{const t=e.target.closest("a");if(t){let e=t.getAttribute("href");e&&(cachedRoutes[e]||wss.send(JSON.stringify({type:"getPage",path:e})))}}))}function loadAsset(e,t){try{const n=document.querySelector(`[resource="${e}"]`);if(n&&n.remove(),e.endsWith(".woff2")){const n=defaultFonts.find((t=>t.path===e));if(!n)return;const o=document.createElement("style");o.setAttribute("resource",e),o.textContent=`\n                @font-face {\n                    font-family: '${n.name}';\n                    src: url(data:font/${n.format};base64,${t}) format('${n.format}');\n                    font-display: ${n.display};\n                    font-weight: normal;\n                    font-style: normal;\n                }\n            `.trim(),document.head.appendChild(o)}else if(e.endsWith(".css")){let n=document.createElement("style");n.type="text/css",n.setAttribute("resource",e),n.innerHTML=t,document.head.appendChild(n)}else if(e.endsWith(".js")){if("/assets/framework/main.js"===e)return;let n=document.createElement("script");n.type="text/javascript",n.setAttribute("resource",e),n.innerHTML=`(function() { ${t} })();`,document.head.appendChild(n)}}catch(e){}}function connectWS(){if(!wss||wss.readyState!==WebSocket.CONNECTING)try{wss=new WebSocket(url),wss.onopen=function(){wsStatus=!0,reconnectAttempts=0,wss.send(JSON.stringify({type:"ping"})),lastKeepAlive=Date.now(),wss.send(JSON.stringify({type:"keepalive"})),setInterval((()=>{wsStatus&&(!lastKeepAlive||Date.now()-lastKeepAlive>6e4)&&(lastKeepAlive=Date.now(),wss.send(JSON.stringify({type:"keepalive"})))}),6e4)},wss.onclose=function(){if(wsStatus=!1,lastKeepAlive=null,reconnectAttempts<maxReconnectAttempts){const e=Math.min(1e3*Math.pow(2,reconnectAttempts),3e4);reconnectAttempts++,reconnectTimeout&&clearTimeout(reconnectTimeout),reconnectTimeout=setTimeout(connectWS,e)}},wss.onerror=function(e){wsStatus=!1},wss.onmessage=function(e){handleWSMessage(JSON.parse(e.data))}}catch(e){if(reconnectAttempts<maxReconnectAttempts){const e=Math.min(1e3*Math.pow(2,reconnectAttempts),3e4);reconnectAttempts++,reconnectTimeout&&clearTimeout(reconnectTimeout),reconnectTimeout=setTimeout(connectWS,e)}}}function handleWSMessage(e){switch(e.type){case"reload":location.reload();break;case"refetch":renderNow=!0,wss.send(JSON.stringify({type:"getPage",path:currentPath}));case"render":renderNow?(render(e.path),renderNow=!1):update(e.path,e.data),cachedRoutes[e.path]=e.data;break;case"manipulate":update(e.path,{props:e.props});break;case"routeData":cachedRoutes[e.path]=e.data.data,window.location.pathname==e.path&&update(e.path,e.data.data);break}}function render(e){currentPath=e,history.pushState({},"",e),cachedRoutes[e]?update(e,cachedRoutes[e]):(renderNow=!0,wss.send(JSON.stringify({type:"getPage",path:e})))}function update(e,{content:t,props:n}){if(!t&&n)for([i,j]of(cachedRoutes[e]={content:cachedRoutes[e]?.content||"",props:n},Object.entries(n)))document.getElementById(`hcf_prop_${i}`).innerHTML=j;else{try{if(null==t||null==t)return location.href=e;const n=(new DOMParser).parseFromString(t,"text/html");if(n.body.innerHTML&&!n.body.querySelector("parsererror")){document.querySelectorAll('head style:not([resource]), head link:not([resource]), head script:not([resource]), head meta:not([name="viewport"])').forEach((e=>e.setAttribute("data-old-element","true")));const e=[];Array.from(n.head.children).forEach((t=>{if(!t.hasAttribute("resource")&&"META"!==t.tagName&&"TITLE"!==t.tagName){const n=t.cloneNode(!0);document.head.appendChild(n),e.push(n)}}));const t=e.filter((e=>"LINK"===e.tagName&&"stylesheet"===e.getAttribute("rel")));t.length>0?Promise.all(t.map((e=>new Promise((t=>{e.sheet?t():(e.onload=t,e.onerror=t)}))))).then((()=>{document.querySelectorAll('[data-old-element="true"]').forEach((e=>e.remove()))})):setTimeout((()=>{document.querySelectorAll('[data-old-element="true"]').forEach((e=>e.remove()))}),10),n.title&&(document.title=n.title),n.body.className&&(document.body.className=n.body.className),document.body.innerHTML=n.body.innerHTML;Array.from(n.body.querySelectorAll("script")).forEach((e=>{const t=document.createElement("script");Array.from(e.attributes).forEach((e=>{t.setAttribute(e.name,e.value)})),e.src?t.src=e.src:t.textContent=e.textContent,e.remove(),document.body.appendChild(t)}))}else document.body.textContent=t}catch(e){document.body.textContent=t}currentPath=e,currentProps=n,cachedRoutes[e]={content:t,props:n},renderNow=!1}}window.onload=()=>{connectWS(),setupClientRouting()},window.addEventListener("popstate",(()=>{const e=window.location.pathname;e!==currentPath&&(currentPath=e,cachedRoutes[e]?update(e,cachedRoutes[e]):(renderNow=!0,wss.send(JSON.stringify({type:"getPage",path:e}))))}));